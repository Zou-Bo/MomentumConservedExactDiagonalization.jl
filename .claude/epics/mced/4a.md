---
name: Momentum Block Division
status: open
created: 2025-09-05T20:01:57Z
updated: 2025-09-05T20:01:57Z
github: https://github.com/Zou-Bo/MomentumConservedExactDiagonalization.jl/issues/6
depends_on: [001, 002, 003]
parallel: true
conflicts_with: []
---

# Task: Momentum Block Division - Generate Momentum-Resolved Basis Blocks

## Description
Implement the momentum block division system that takes a full Hilbert space basis (list of MBS64 states with specified particle numbers for conserved components) and divides it into momentum blocks - subsets of states with the same total momentum. Each block will be processed independently in parallel diagonalization.

## Acceptance Criteria
- [ ] Generate complete Hilbert space basis with user-specified particle numbers per conserved component
- [ ] Calculate total momentum for each MBS64 state using existing orbital indexing
- [ ] Group states into momentum blocks with identical total momentum (mod G)
- [ ] Implement efficient momentum calculation using bit operations on MBS64 states
- [ ] Create block data structure containing: momentum value, list of states, state indices
- [ ] Optimize for memory efficiency with large basis sets (up to 2^64 states)
- [ ] Handle edge cases: empty blocks, single-state blocks, maximum momentum constraints
- [ ] Provide utilities for block-to-full basis mapping and index conversion
- [ ] Create comprehensive tests for momentum calculation and block division

## Technical Details

### Basis Generation Process
1. **Particle Constraints**: Generate all MBS64 states with specified particle numbers in each conserved component
2. **Momentum Calculation**: Compute total momentum for each state using orbital positions
3. **Block Formation**: Group states by momentum values (mod G conservation)
4. **Index Mapping**: Create bidirectional maps between full basis and block indices

### Momentum Calculation Algorithm
Using existing orbital indexing: `i = ik + Nk * (ic-1) + (Nk * Nc_hopping) * (icc-1)`
- **Bit Traversal**: Iterate through occupied orbitals in MBS64 state
- **Momentum Sum**: Sum momentum vectors for all occupied orbitals
- **Modulo Operation**: Apply momentum conservation: `K_total mod Gk`

### Block Data Structure
```julia
struct MomentumBlock
    momentum::Tuple{Int,Int}  # (kx, ky) total momentum
    states::Vector{MBS64}     # List of states in this block
    indices::Vector{Int}      # Corresponding indices in full basis
    dimension::Int           # Number of states in block
end
```

### Implementation Strategy
1. **Single File**: Create `src/momentum_blocks.jl` with complete implementation
2. **Efficient Algorithms**: Use bit operations for momentum calculation
3. **Memory Management**: Stream large basis generation to avoid memory overflow
4. **Parallel Ready**: Design for parallel processing of independent blocks

### Key Functions to Implement
- `generate_basis(particle_numbers, edpara)`: Create full basis with constraints
- `calculate_momentum(state, edpara)`: Compute total momentum of state
- `divide_into_blocks(basis, edpara)`: Split basis into momentum blocks
- `get_block_mapping(blocks)`: Create index conversion utilities

### Performance Considerations
- **Bit Operations**: Use UInt64 operations for efficient state processing
- **Memory Streaming**: Process large basis sets in chunks
- **Preallocation**: Estimate block sizes to avoid repeated allocations
- **Type Stability**: Ensure concrete types for hot loops

### Files to Create
- `src/momentum_blocks.jl`: Complete momentum block implementation (single file)
- `test/test_momentum_blocks.jl`: Comprehensive block division tests

### Validation Requirements
- **Momentum Conservation**: Verify total momentum calculation correctness
- **Completeness**: Ensure all basis states are assigned to blocks
- **Uniqueness**: Check no state appears in multiple blocks
- **Edge Cases**: Handle minimum/maximum momentum values properly

## Dependencies
- [ ] Task 001.md - Package Foundation (provides project structure)
- [ ] Task 002.md - Core EDPara Struct (required for momentum parameters)
- [ ] Task 003.md - MBS64 Type (required for state representation)
- [ ] Access to ExactDiagonalization.jl momentum calculation code

## Effort Estimate
- Size: M (Medium)
- Hours: 4 hours
- Parallel: true (can run after scattering lists are ready)

## Definition of Done
- [ ] Complete basis generation with particle number constraints
- [ ] Accurate momentum calculation for all states
- [ ] Efficient block division with proper data structures
- [ ] Index mapping utilities working correctly
- [ ] Comprehensive tests validate all functionality
- [ ] Performance benchmarks show efficient block generation
- [ ] Code review confirms mathematical correctness and efficiency