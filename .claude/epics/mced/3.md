---
name: MBS64 Type and Manipulation Functions
status: completed
created: 2025-09-05T20:01:57Z
updated: 2025-09-05T20:01:57Z
github: https://github.com/Zou-Bo/MomentumConservedExactDiagonalization.jl/issues/4
depends_on: [001, 002]
parallel: true
conflicts_with: []
---

# Task: MBS64 Type and Manipulation Functions - Migrate and Improve Existing Implementation

## Description
Migrate the existing MBS64 (Many-Body State 64-bit) type from ExactDiagonalization.jl and improve it by changing from Int64 wrapper to UInt64 wrapper. The Hilbert space is already defined by EDPara, so no separate Hilbert space type is needed. Focus on migrating all existing bit manipulation functions and state operations.

## Acceptance Criteria
- [ ] Migrate existing MBS64 type from Int64 wrapper to UInt64 wrapper for better bit semantics
- [ ] Preserve all existing bit manipulation functions: creation/annihilation operators, occupation checks
- [ ] Maintain existing state indexing and orbital mapping functionality
- [ ] Transfer all existing utility functions: particle counting, momentum calculations, state operations
- [ ] Migrate comprehensive test suite for bit operations and state manipulations
- [ ] Ensure compatibility with existing EDPara orbital indexing: `i = ik + Nk * (ic-1) + (Nk * Nc_hopping) * (icc-1)`
- [ ] Update documentation to reflect UInt64 change and maintain API compatibility
- [ ] Verify all existing dependent code works with UInt64 wrapper

## Technical Details

### Current MBS64 Implementation
The existing MBS64 is a simple wrapper around Int64 representing many-body states where each bit indicates orbital occupation:
```julia
struct MBS64 <: Integer
    state::Int64
end
```

### Required Changes
- **Type Change**: `MBS64(state::UInt64)` instead of `Int64`
- **Bit Semantics**: UInt64 better represents bit operations semantics
- **Compatibility**: Ensure all existing functions work with UInt64

### Functions to Migrate
Based on existing codebase analysis:
- **Creation/Annihilation**: `create_particle()`, `annihilate_particle()`
- **Occupation Checks**: `is_occupied()`, `get_occupation()`
- **Particle Counting**: `count_particles()`, `get_particle_number()`
- **State Operations**: `get_state()`, `set_state()`, `flip_orbital()`
- **Momentum Operations**: Functions using orbital indexing formula
- **Utility Functions**: `get_empty_state()`, `get_full_state()`, `get_occupied_orbitals()`

### Implementation Strategy
1. **Single File**: Create `src/mbs64.jl` with complete implementation
2. **Type Definition**: `struct MBS64 <: Integer; state::UInt64; end`
3. **Bit Operations**: All bit manipulation functions using UInt64 operations
4. **EDPara Integration**: Functions that work with EDPara orbital indexing
5. **Testing**: Comprehensive tests for all bit operations and edge cases

### Key Implementation Details
- **Bit Indexing**: Orbitals mapped to bit positions 0-63
- **Orbital Formula**: Use existing `i = ik + Nk * (ic-1) + (Nk * Nc_hopping) * (icc-1)`
- **Type Stability**: Ensure all functions return concrete types
- **Performance**: Inline bit operations for hot loops

### Files to Create
- `src/mbs64.jl`: Complete MBS64 implementation (single file)
- `test/test_mbs64.jl`: Comprehensive bit operation tests

### Migration Considerations
- **Backward Compatibility**: Ensure existing code works with UInt64
- **Performance**: UInt64 bit operations may be faster on some architectures
- **Memory**: Same memory footprint (64 bits per state)
- **API Consistency**: Maintain exact function signatures where possible

## Dependencies
- [ ] Task 001.md - Package Foundation (provides project structure)
- [ ] Task 002.md - Core EDPara Struct (required for orbital indexing)
- [ ] Access to ExactDiagonalization.jl MBS64 implementation

## Effort Estimate
- Size: S (Small)
- Hours: 3 hours
- Parallel: true (independent migration task)

## Definition of Done
- [ ] MBS64 type successfully changed to UInt64 wrapper
- [ ] All existing bit manipulation functions migrated and working
- [ ] EDPara orbital indexing integration preserved
- [ ] Comprehensive test suite passes
- [ ] Performance benchmarks show improvement or no regression
- [ ] Code review confirms exact functionality preservation with UInt64 improvement
