---
name: Sparse Matrix Construction
status: open
created: 2025-09-05T20:01:57Z
updated: 2025-09-05T20:01:57Z
github: https://github.com/Zou-Bo/MomentumConservedExactDiagonalization.jl/issues/7
depends_on: [001, 002, 003, 004, 4a]
parallel: true
conflicts_with: []
---

# Task: Sparse Matrix Construction - Convert Scattering Lists to Sparse Hamiltonian

## Description
Implement the sparse matrix construction system that converts scattering lists (one-body and two-body terms) into actual sparse matrix Hamiltonians for each momentum block. Focus on improving efficiency over the original implementation while maintaining correctness.

## Acceptance Criteria
- [ ] Convert one-body scattering lists to sparse matrix elements efficiently
- [ ] Convert two-body scattering lists to sparse matrix elements with proper indexing
- [ ] Implement optimized sparse matrix assembly using Julia's SparseArrays
- [ ] Handle Hermitian matrix structure properly (fill only upper triangle, mirror lower)
- [ ] Optimize memory allocation and matrix construction speed
- [ ] Support both real and complex matrix elements from scattering amplitudes
- [ ] Implement matrix validation: Hermiticity, correct dimensions, non-zero structure
- [ ] Create comprehensive tests comparing against known results and dense matrices
- [ ] Profile and optimize performance bottlenecks in original implementation

## Technical Details

### Matrix Construction Process
1. **Scattering Application**: Apply scattering terms to basis states to get matrix elements
2. **Index Mapping**: Convert orbital indices to matrix row/column indices within block
3. **Sparse Assembly**: Build CSC sparse matrix from coordinate lists
4. **Hermitian Completion**: Mirror upper triangle to lower triangle for Hermitian matrices

### Sparse Matrix Optimization
```julia
# Target optimization areas:
# - Preallocate I, J, V arrays for COO format
# - Use sparse() constructor efficiently
# - Minimize memory allocations during assembly
# - Leverage Julia's SparseArrays.CSC format
```

### Implementation Strategy
1. **Single File**: Create `src/sparse_matrix.jl` with complete implementation
2. **Performance Focus**: Profile and optimize over original implementation
3. **Memory Efficiency**: Minimize allocations during matrix construction
4. **Type Generic**: Support both real and complex matrix elements

### Key Functions to Implement
- `build_sparse_hamiltonian_1body(scattering1, block)`: Convert 1-body terms
- `build_sparse_hamiltonian_2body(scattering2, block)`: Convert 2-body terms
- `assemble_sparse_matrix(elements, block_size)`: Efficient sparse assembly
- `validate_hamiltonian(matrix, block)`: Check Hermiticity and correctness

### Performance Improvements to Consider
- **Preallocation**: Estimate non-zero elements to preallocate arrays
- **Batch Processing**: Process multiple scattering terms together
- **Cache Optimization**: Optimize memory access patterns
- **Type Specialization**: Use concrete types for performance-critical code

### Original Implementation Analysis
The original code may have inefficiencies in:
- **Repeated Allocations**: Growing arrays during construction
- **Index Calculations**: Redundant computations in hot loops
- **Memory Access**: Non-optimal access patterns for sparse data
- **Type Instability**: Abstract types in performance-critical sections

### Files to Create
- `src/sparse_matrix.jl`: Complete sparse matrix construction (single file)
- `test/test_sparse_matrix.jl`: Comprehensive matrix construction tests
- `benchmarks/matrix_construction.jl`: Performance comparison benchmarks

### Validation Requirements
- **Hermiticity**: Verify H[i,j] = conj(H[j,i]) for all elements
- **Dimensions**: Check matrix dimensions match block size
- **Non-zeros**: Validate sparse structure matches scattering terms
- **Accuracy**: Compare against dense matrix construction for small systems

### Performance Benchmarks
- **Speed**: Compare against original implementation
- **Memory**: Measure allocation efficiency improvements
- **Scalability**: Test with increasing system sizes
- **Accuracy**: Ensure numerical precision is maintained

## Dependencies
- [ ] Task 001.md - Package Foundation (provides project structure)
- [ ] Task 002.md - Core EDPara Struct (required for parameters)
- [ ] Task 003.md - MBS64 Type (required for state representation)
- [ ] Task 004.md - Hamiltonian Scattering Lists (required for input)
- [ ] Task 4a.md - Momentum Block Division (required for basis blocks)
- [ ] Access to ExactDiagonalization.jl sparse matrix code for comparison

## Effort Estimate
- Size: M (Medium)
- Hours: 5 hours
- Parallel: true (can run alongside momentum block division)

## Definition of Done
- [ ] Efficient sparse matrix construction from scattering lists
- [ ] Performance improvements over original implementation
- [ ] Comprehensive validation of matrix properties
- [ ] Memory usage optimized for large systems
- [ ] Tests validate correctness against known results
- [ ] Performance benchmarks demonstrate improvements
- [ ] Code review confirms optimization effectiveness and correctness