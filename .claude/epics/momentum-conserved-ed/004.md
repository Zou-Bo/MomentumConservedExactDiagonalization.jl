---
title: "Hamiltonian Builder: Sparse Matrix Assembly"
epic: "momentum-conserved-ed"
task_id: 004
status: "pending"
priority: "high"
depends_on: [001, 002, 003]
estimated_hours: 12
complexity: "medium"
tags: ["hamiltonian", "sparse-matrix", "block-structure", "performance"]
---

# Hamiltonian Builder: Implement sparse Hamiltonian matrix assembly with block structure

## Overview
Implement efficient Hamiltonian matrix construction leveraging momentum conservation to create block-diagonal sparse matrices, enabling larger system sizes through reduced memory footprint and computational complexity.

## Acceptance Criteria

### Core Functionality
- [ ] Implement `build_sparse_hamiltonian` function that constructs Hamiltonian in momentum blocks
- [ ] Support both translationally invariant and non-invariant Hamiltonians
- [ ] Generate correct block-diagonal structure with proper momentum quantum numbers
- [ ] Handle periodic boundary conditions correctly for all momentum sectors
- [ ] Memory-efficient sparse matrix construction using CSC/CSR formats

### Performance Requirements
- [ ] Construct 16-site Heisenberg chain Hamiltonian in < 5 seconds
- [ ] Memory usage scales as O(NÂ·2^N) instead of O(4^N) for dense matrices
- [ ] Support system sizes up to 20 sites for spin-1/2 chains
- [ ] Parallel construction of independent momentum blocks

### Validation
- [ ] Unit tests verify correct eigenvalues for small systems against exact diagonalization
- [ ] Cross-validate with known results for 4-8 site systems
- [ ] Verify hermiticity and correct dimensionality for all blocks
- [ ] Test edge cases: 1-site, 2-site, odd/even system sizes

## Technical Details

### Key Components

#### 1. Momentum Sector Decomposition
```julia
struct MomentumBlock
    k::Int                    # Momentum quantum number (0, 1, ..., L-1)
    basis_states::Vector{Int} # Basis states in this momentum sector
    basis_size::Int          # Number of states in this block
    hamiltonian::SparseMatrixCSC{ComplexF64, Int64}  # Hamiltonian matrix for this block
end
```

#### 2. Hamiltonian Construction Pipeline
- **Basis Generation**: Map momentum sectors to basis states using translation operators
- **Matrix Elements**: Compute matrix elements using momentum-conserving operators
- **Sparse Assembly**: Construct sparse matrices for each momentum block
- **Block Validation**: Verify hermiticity and dimensions

#### 3. Algorithm Implementation
```julia
function build_sparse_hamiltonian(hamiltonian_terms, lattice_size, momentum_sectors)
    # 1. Generate momentum-resolved basis
    basis_by_k = generate_momentum_basis(lattice_size, momentum_sectors)
    
    # 2. Build Hamiltonian blocks
    blocks = Dict{Int, MomentumBlock}()
    for k in momentum_sectors
        H_k = build_hamiltonian_block(hamiltonian_terms, basis_by_k[k], k)
        blocks[k] = MomentumBlock(k, basis_by_k[k], length(basis_by_k[k]), H_k)
    end
    
    return blocks
end
```

### Implementation Strategy
1. **Basis State Encoding**: Use integer bitstrings to represent spin configurations
2. **Translation Operators**: Efficient implementation using bit manipulation
3. **Matrix Element Calculation**: Direct computation avoiding full basis construction
4. **Sparse Matrix Formats**: Use CSC format for efficient arithmetic operations

### Edge Cases & Considerations
- **System Size Limits**: Handle memory constraints for large systems gracefully
- **Boundary Conditions**: Support open and periodic boundary conditions
- **Symmetry Breaking**: Allow for perturbations that break translational symmetry
- **Numerical Precision**: Ensure hermiticity to machine precision

## Dependencies
- Tasks 001, 002, 003 for basis state generation and symmetry operations
- SparseArrays.jl for efficient sparse matrix operations
- LinearAlgebra.jl for matrix operations and validation

## Testing Strategy
- **Unit Tests**: Test individual components (basis generation, matrix elements)
- **Integration Tests**: Full Hamiltonian construction and diagonalization
- **Performance Tests**: Benchmark against known results and scaling behavior
- **Validation Tests**: Compare with brute-force dense matrix construction

## Files to Create/Modify
- `src/hamiltonian/sparse_builder.jl` - Main Hamiltonian construction
- `src/hamiltonian/momentum_blocks.jl` - Momentum sector handling
- `test/hamiltonian/test_sparse_builder.jl` - Comprehensive test suite
- `benchmarks/hamiltonian_performance.jl` - Performance benchmarks